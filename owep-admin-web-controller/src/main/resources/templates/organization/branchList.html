<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">

    <title>H+ 智慧教育平台 - 分支机构</title>

    <meta name="keywords" content="H+后台主题,后台bootstrap框架,会员中心主题,后台HTML,响应式后台">
    <meta name="description"
          content="H+是一个完全响应式，基于Bootstrap3最新版本开发的扁平化主题，她采用了主流的左右两栏式布局，使用了Html5+CSS3等现代技术">

    <!--[if lt IE 9]>
    <meta http-equiv="refresh" content="0;ie.html"/>
    <![endif]-->

    <link rel="shortcut icon" href="../../static/favicon.ico" th:href="@{/static/favicon.ico}">
    <link href="../../static/css/bootstrap.min.css?v=3.3.6" th:href="@{/static/css/bootstrap.min.css(v='3.3.6')}"
          rel="stylesheet">
    <link href="../../static/css/font-awesome.min.css?v=4.4.0" th:href="@{/static/css/font-awesome.min.css(v='4.4.0')}"
          rel="stylesheet">
    <link href="../../static/css/animate.css" th:href="@{/static/css/animate.css}" rel="stylesheet">
    <link href="../../static/css/style.css?v=4.1.0" th:href="@{/static/css/style.css(v='4.1.0')}" rel="stylesheet">
    <link href="../../static/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet"
          th:href="@{/static/css/plugins/bootstrap-table/bootstrap-table.min.css}">
    <!-- 弹出框插件 -->
    <link href="../../static/css/plugins/sweetalert/sweetalert.css"
          th:href="@{/static/css/plugins/sweetalert/sweetalert.css}" rel="stylesheet">
    <style type="text/css">
        .table > thead > tr > th {
            color: #2a62bc;
        }

    </style>

</head>
<body class="gray-bg">
<div class="wrapper-content wrapper animated fadeInRight">

    <form class="form-inline">
        <div class="form-group">
            <label>分支名称:</label>
            <input type="text" name="branch_name" class="form-control" id="name">
        </div>
        <div class="form-group">
            <label>&nbsp;&nbsp;所属机构:</label>
            <div class="input-group">
                <input type="text" class="form-control org" id="query_org">
                <div class="input-group-btn">
                    <button type="button" class="btn btn-white dropdown-toggle" data-toggle="dropdown">
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-right" role="menu">
                    </ul>
                </div>
                <!-- /btn-group -->
            </div>
        </div>
        <button class="btn-success btn">查询</button>
        <div style="float: right">
            <!-- Button trigger modal -->
            <button type="button" class="btn btn-success " data-toggle="modal" data-target="#myModal">
                添加
            </button>
            <!-- Modal -->
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" id="add">增加</h4>
                        </div>
                        <div class="modal-body form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">分支名称</label>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="branch_name"
                                           placeholder="请输入分支名称">
                                </div>
                            </div>
                            <div class="form-group form-inline">
                                <label class="col-md-2 control-label ">所属机构</label>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <input type="text" class="form-control org" id="add_org">
                                        <div class="input-group-btn">
                                            <button type="button" class="btn btn-white dropdown-toggle"
                                                    data-toggle="dropdown">
                                                <span class="caret"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-right" role="menu">
                                            </ul>
                                        </div>
                                        <!-- /btn-group -->
                                    </div>
                                </div>
                            </div>
                            <!--footer-->
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">
                                    关闭
                                </button>
                                <button type="submit" class="btn btn-primary"
                                        id="save_branch_btn">保存
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" id="delete" class="btn btn-danger">删除</button>
        </div>
    </form>

    <table class="table table-striped" id="myTab">
        <!--模态框-->
        <div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="change">修改</h4>
                    </div>
                    <div class="modal-body form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">分支名称</label>
                            <div class="col-sm-4">
                                <input type="text" class="form-control" id="branch_content">
                            </div>
                        </div>
                        <div class="form-group form-inline">
                            <label class="col-md-2 control-label ">所属机构</label>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="text" class="form-control org" id="org_content" disabled>
                                </div>
                            </div>
                        </div>
                        <!--footer-->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                            <button type="button" class="btn btn-primary" id="save_edit">保存</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </table>
</div>

<!--表单-->

<!-- 全局js -->
<script src="../../static/js/jquery.min.js?v=2.1.4" th:src="@{/static/js/jquery.min.js(v='2.1.4')}"></script>
<script src="../../static/js/bootstrap.min.js?v=3.3.6" th:src="@{/static/js/bootstrap.min.js(v='3.3.6')}"></script>

<!-- 自定义js -->
<script src="../../static/js/content.js?v=1.0.0" th:src="@{/static/js/content.js(v='1.0.0')}"></script>
<!--bootstrap-table-->
<script src="../../static/js/plugins/bootstrap-table/bootstrap-table.min.js"
        th:src="@{/static/js/plugins/bootstrap-table/bootstrap-table.min.js}"></script>
<script src="../../static/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"
        th:src="@{/static/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js}"></script>
<script src="../../static/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"
        th:src="@{/static/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js}"></script>
<script src="../../static/js/plugins/suggest/bootstrap-suggest.min.js"
        th:src="@{/static/js/plugins/suggest/bootstrap-suggest.min.js}"></script>
<!-- 弹出框插件 -->
<script src="../../static/js/plugins/sweetalert/sweetalert.min.js"
        th:src="@{/static/js/plugins/sweetalert/sweetalert.min.js}"></script>
<script>
    $(function () {
        $("#myTab").bootstrapTable({
            url: "/owep/organization/branchTable",
            toolbar: '#toolbar', // 工具按钮用哪个容器
            pagination: true,
            cache: false,
            clickToSelect: true, //单击选中
            sortable: true, //是否启用排序
            sortOrder: "asc", // 排序方式
            sidePagination: "client", // 分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,
            pageSize: 3,
            pageList: [3, 6, 9, 12],
            /*  search:true,*/
            strictSearch: false,                 //查询时是否严格匹配, true表示严格匹配，false表示模糊匹配
            /* showRefresh:true,*/
            uniqueId: "ID",
            columns: [{
                field: 'checked',
                checkbox: true, /* 是否添加复选框*/
                //跟据返回每行的数据
                formatter: function (value, row, index) {
                    return row.id;
                }
            },
                {
                    field: 'branchName',
                    title: '分支名称'
                }, {
                    field: 'subsidiaryOrgan',
                    title: '所属机构'
                }, {
                    field: 'createTime',
                    title: '创建时间',
                }, {

                    field: 'operator',
                    title: '操作',
                    align: 'center',
                    valign: 'middle',
                    width: '10%',
                    // visible: false,
                    formatter: function (value, row, index) {
                        // var sid_code = base64encode(row.sid + '');   //  sid 加密处理
                        // alert(sid_code);
                        return '<a  data-toggle="modal" data-target="#updateModal" title="修改">' +
                            '<i class="glyphicon glyphicon-edit"></i> ' +
                            '</a>' +
                            '<a href="javascript:void(0)" title="删除">' +
                            '<i class="glyphicon glyphicon-trash text-danger"></i> ' +
                            '</a>';
                    },
                    events: {
                        'click a[title=删除]': function (e, value, row, index) {
                            $.ajax({
                                url: '/owep/organization/branch/delete?id=' + row.instituteId,
                                method: 'get',
                                success: function (data) {
                                    if (data.code === 0) {
                                        setTimeout(function () {
                                            swal("修改成功！", data.msg, "success")
                                        }, 100);
                                        setTimeout(function () {
                                            window.location.reload();
                                        }, 2000);
                                    } else {
                                        setTimeout(function () {
                                            swal("修改失败！", data.msg, "success")
                                        }, 100);
                                    }
                                },
                                error: function (jqXHR) {
                                    swal("同步失败！", "请稍后重试", "error");
                                }
                            });
                        },
                        'click a[title=修改]': function (e, value, row, index) {
                            $("#branch_content").val(row.branchName);
                            $('#org_content').val(row.subsidiaryOrgan);
                            //保存修改
                            $('#save_edit').click(function () {
                                let branchName = $("#branch_content").val();
                                //修改后的数据
                                let branchData = {
                                    id: row.id,
                                    branchName: branchName,
                                    subsidiaryOrgan: row.subsidiaryOrgan
                                }
                                //修改请求
                                $.ajax({
                                    url: '/owep/organization/branch/edit',
                                    method: 'post',
                                    data: JSON.stringify(branchData),
                                    dataType: "json",   //期望服务端返回的数据类型
                                    contentType: "application/json",
                                    success: function (data) {
                                        if (data.code === 0) {
                                            setTimeout(function () {
                                                swal("修改成功！", data.msg, "success")
                                            }, 100);
                                            setTimeout(function () {
                                                window.location.reload();
                                            }, 2000);
                                        } else {
                                            setTimeout(function () {
                                                swal("修改失败！", data.msg, "success")
                                            }, 100);
                                        }
                                    },
                                    error: function (jqXHR) {
                                        swal("同步失败！", "请稍后重试", "error");
                                    }
                                })
                            })
                        }
                    }
                }]
        });
        $(".org").bsSuggest({
            indexId: 2,
            indexKey: 1,
            data: {
                'value': [
                    {
                        "id": "",
                        "word": "萍乡学院"
                    },
                    {
                        "id": "",
                        "word": "快程乐码"
                    }
                ]
            }
        });
        $(".organization").bsSuggest({
            indexId: 2,
            indexKey: 1,
            data: {
                'value': [
                    {
                        "id": "",
                        "word": "萍乡学院"
                    },
                    {
                        "id": "",
                        "word": "快程乐码"
                    }
                ]
            }
        });
        //查询
        $("#query").click(function () {
            let branchName = $("#name").val();
            let instituteName = $("#query_org").val();
            let instituteType;
            if (instituteName === "快程乐码")
                instituteType = 2;
            if (instituteName === "萍乡学院")
                instituteType = 1;

            if (instituteType === undefined) {
                alert("没有匹配的组织机构");
                return;
            }

            let queryData = {
                branchName: branchName,
                instituteType: instituteType,
            };
            console.log(queryData);
            $.ajax({
                method: "post",
                url: "/owep/organization/query",
                async: "false",
                data: queryData, //不转为JSON 单独接收两个参数
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                    if (data.code === 0)
                        $('#myTab').bootstrapTable("load", data.data);
                    else
                        alert("查询失败");
                },
                error: function (jqXRH) {
                    console.log(jqXRH);
                    alert("查询失败");
                }
            });
        })

        //新增
        $('#save_branch_btn').click(function () {
            let branchName = $('#branch_name').val();
            let orgName = $('#add_org').val();
            console.log(branchName + "============" + orgName);
            let branch = {
                branchName: branchName,
                subsidiaryOrgan: orgName
            };
            $.ajax({
                method: "post",
                url: "/owep/organization/branch/addBranch",
                async: "true",
                data: JSON.stringify(branch),
                dataType: "json",
                contentType: "application/json",
                success: function (data) {
                    if (data.code === 0) {
                        setTimeout(function () {
                            swal("添加成功", data.msg, "success");
                        }, 100)
                        setTimeout(function () {
                            window.location.reload();
                        }, 1000);
                    } else {
                        setTimeout(function () {
                            swal("添加失败", data.msg, "error");
                        }, 100)
                        setTimeout(function () {
                            window.location.reload();
                        }, 1000);
                    }
                },
                error: function (jqXRH) {
                    swal("添加失败", jqXRH.msg, "error");
                    setTimeout(function () {
                        window.location.reload();
                    }, 1000);
                }
            });
        })
        //批量删除
        $('#delete').click(function () {
            let rows = $('#myTab').bootstrapTable('getAllSelections');
            console.log(rows);
            let ids = [];
            rows.forEach(item => ids.push(item.id))
            if (rows.length === 0) {
                alert("请至少选择一个")
            } else {
                if (confirm("确定删除这些数据么")) {
                    alert("删除:" + ids);
                    //ajax发送异步请求
                    $.ajax({
                        url: '/owep/organization/branch/deleteByIds',
                        method: "post",
                        data: ids,
                        dataType: "json",
                        async: "true",
                        contentType: "application/json",
                        success: function (data) {
                            if (data.code === 0) {
                                setTimeout(function () {
                                    swal("修改成功！", data.msg, "success")
                                }, 100);
                                setTimeout(function () {
                                    window.location.reload();
                                }, 2000);
                            } else {
                                setTimeout(function () {
                                    swal("修改失败！", data.msg, "success")
                                }, 100);
                            }
                        },
                        error: function (jqXHR) {
                            swal("同步失败！", "请稍后重试", "error");
                        }
                    })
                }
            }
        });

    });

</script>

</body>

</html>